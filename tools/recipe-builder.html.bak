<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Recipe Builder</title>

<style>
body { font-family: system-ui; margin: 30px; max-width: 900px; }
h2 { margin-top: 40px; }
input, select, textarea, button { margin: 4px 0; padding: 6px; }
.row { border: 1px solid #ccc; padding: 8px; margin-bottom: 6px; }
.small { width: 80px; }
button { cursor: pointer; }
textarea { width:100%; }
#jsonOutput {
  height:180px;
  background:#111;
  color:#00ff99;
  font-family:monospace;
  padding:10px;
  border-radius:6px;
}
</style>
</head>
<body>

<h1>Recipe Builder</h1>

<h2>Basic Info</h2>

<input id="title" placeholder="Title"><br>
<input id="subtitle" placeholder="Subtitle"><br>
<input id="category" placeholder="Category"><br>
<input id="author" placeholder="Author"><br>
<input id="source" placeholder="Source"><br>
<input id="servings" placeholder="Servings (e.g. Serves 4)"><br>
<input id="timing" placeholder="Timing (e.g. 20 min prep Â· 40 min cook)"><br>

<h2>Ingredients</h2>
<div id="ingredients"></div>
<button onclick="addIngredient()">Add Ingredient</button>

<h2>Procedure</h2>
<div id="procedure"></div>
<button onclick="addStep()">Add Step</button>

<h2>Notes</h2>
<div id="notes"></div>
<button onclick="addNote()">Add Note</button>

<br><br>
<button onclick="generate()">Generate Recipe</button>

<hr style="margin:40px 0;">

<h2>recipes.json Entry</h2>
<p>Copy this and paste into <code>data/recipes.json</code>:</p>

<textarea id="jsonOutput"></textarea>
<br><br>
<button onclick="copyJSON()">Copy JSON to Clipboard</button>

<script>
function slugify(text) {
  return text.toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

function addIngredient() {
  const container = document.getElementById('ingredients');
  if (!container) return;

  const div = document.createElement('div');
  div.className = 'row';
  div.innerHTML = `
    <label><input type="checkbox" class="qualToggle"> Qualitative</label><br>
    <input class="amount small" placeholder="Amount">
    <input class="unit small" placeholder="Unit">
    <input class="range small" placeholder="Max">
    <input class="amountText" placeholder="e.g. a splash" style="display:none">
    <input class="ingredient" placeholder="Ingredient">
    <input class="notes" placeholder="Notes">
    <label><input type="checkbox" class="optional"> Optional</label>
  `;

  div.querySelector('.qualToggle').addEventListener('change', function() {
    const isQual = this.checked;
    div.querySelector('.amount').style.display = isQual ? 'none' : '';
    div.querySelector('.unit').style.display = isQual ? 'none' : '';
    div.querySelector('.range').style.display = isQual ? 'none' : '';
    div.querySelector('.amountText').style.display = isQual ? '' : 'none';
  });

  container.appendChild(div);
}

function addStep() {
  const container = document.getElementById('procedure');
  if (!container) return;

  const div = document.createElement('div');
  div.className = 'row';
  div.innerHTML = `<textarea class="step" rows="2"></textarea>`;
  container.appendChild(div);
}

function addNote() {
  const container = document.getElementById('notes');
  if (!container) return;

  const div = document.createElement('div');
  div.className = 'row';
  div.innerHTML = `<textarea class="note" rows="2"></textarea>`;
  container.appendChild(div);
}

function copyJSON() {
  const textarea = document.getElementById('jsonOutput');
  textarea.select();
  document.execCommand('copy');
  alert("JSON copied to clipboard.");
}

function clearForm() {
  document.querySelectorAll('input').forEach(i => i.value = '');
  document.getElementById('ingredients').innerHTML = '';
  document.getElementById('procedure').innerHTML = '';
  document.getElementById('notes').innerHTML = '';
  document.getElementById('jsonOutput').value = '';
  addIngredient();
  addStep();
}

async function generate() {
  const title = document.getElementById('title').value.trim();
  if (!title) {
    alert("Title is required.");
    return;
  }

  const slug = slugify(title);
  const category = document.getElementById('category').value.trim();
  const author = document.getElementById('author').value.trim();
  const source = document.getElementById('source').value.trim();
  const subtitle = document.getElementById('subtitle').value.trim();
  const servings = document.getElementById('servings').value.trim();
  const timing = document.getElementById('timing').value.trim();

  const recipeObject = {
    title,
    slug,
    category,
    author,
    source,
    servings,
    ingredients: [],
    procedure: [],
    notes: []
  };

  const template = await fetch('../templates/recipe-template.html')
    .then(r => r.text());

  let finalHTML = template
    .replaceAll('{{TITLE}}', title)
    .replaceAll('{{SUBTITLE}}', subtitle)
    .replaceAll('{{CATEGORY}}', category)
    .replaceAll('{{AUTHOR}}', author)
    .replaceAll('{{SOURCE}}', source)
    .replaceAll('{{SERVINGS}}', servings)
    .replaceAll('{{TIMING}}', timing)
    .replace('{{RECIPE_JSON}}', JSON.stringify(recipeObject, null, 2));

  const htmlBlob = new Blob([finalHTML], { type: 'text/html' });
  const htmlUrl = URL.createObjectURL(htmlBlob);

  const link = document.createElement('a');
  link.href = htmlUrl;
  link.download = slug + '.html';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(htmlUrl);

  const sidebarEntry = {
    title,
    slug,
    category,
    path: slug + '.html',
    author,
    source
  };

  document.getElementById('jsonOutput').value =
    JSON.stringify(sidebarEntry, null, 2) + ",";

  const jsonBlob = new Blob(
    [JSON.stringify(sidebarEntry, null, 2)],
    { type: 'application/json' }
  );

  const jsonUrl = URL.createObjectURL(jsonBlob);

  const jsonLink = document.createElement('a');
  jsonLink.href = jsonUrl;
  jsonLink.download = slug + '.sidebar.json';

  document.body.appendChild(jsonLink);
  jsonLink.click();
  document.body.removeChild(jsonLink);
  URL.revokeObjectURL(jsonUrl);

  alert("Recipe generated successfully.");

  if (confirm("Generate another recipe?")) {
    clearForm();
  }
}

document.addEventListener('DOMContentLoaded', function() {
  addIngredient();
  addStep();
});
</script>

</body>
</html>